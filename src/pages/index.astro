---
import Layout from '../layouts/Layout.astro';

import "../style/global.css";

import ProductCard from "../components/ProductCard.astro";
import Personabanner from '../components/personabanner.astro';
import Apropos from '../components/Apropos.astro';
import Banner from '../components/banner.astro';
import pb from "../utils/pb";

// Fetch products from PocketBase (server-side)
const productsRaw = await pb.collection('product').getFullList({ sort: '-created' });

// Normalize product fields for the UI and build image URLs when needed
const products = productsRaw.map((r) => {
  // try several common field names
  const title = r.title || r.name || 'Produit sans titre';
  const price = r.prix ?? r.price ?? '';

  // handle image field: could be a filename, array, or full URL
  let imageUrl = '/placeholder.jpg';
  const imgField = r.image || r.images || r.photos || null;

  if (imgField) {
    if (typeof imgField === 'string') {
      imageUrl = imgField.startsWith('http') ? imgField : pb.getFileUrl(r, imgField);
    } else if (Array.isArray(imgField) && imgField.length) {
      imageUrl = typeof imgField[0] === 'string' && imgField[0].startsWith('http')
        ? imgField[0]
        : pb.getFileUrl(r, imgField[0]);
    }
  }

  // Ensure we have all required fields
  return {
    id: r.id,
    title,
    price: typeof price === 'number' ? `${price} â‚¬` : price,
    image: imageUrl,
    link: `/Produits?id=${r.id}`,
  };
});
---

<Layout>
  <Personabanner />
<br><br><br><br>

<!-- Produits venant de PocketBase -->
<section class="mx-[100px] mb-12">
  <h2 class="font-jockey text-3xl mb-6">Tendances</h2>

  {products.length === 0 ? (
    <p class="text-gray-500">Aucun produit disponible pour le moment.</p>
  ) : (
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      {products.map((p) => (
        <ProductCard image={p.image} title={p.title} price={p.price} link={p.link} />
      ))}
    </div>
  )}
</section>

<br><br><br><br><br><br>
<Apropos />
<Banner />
</Layout>
