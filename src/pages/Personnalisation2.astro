---
import Layout from "../layouts/Layout.astro";
import pb from "../utils/pb";

let user = await pb.authStore.model;



// const userId = user?.id || null;
let svgCode = "";
let lunetteId = null;
const couleur_branches = await pb.collection('COULEUR_BRANCHES').getFullList();
const couleur_monture = await pb.collection('COULEUR_MONTURE').getFullList();

---
<Layout>
  <div class="min-h-screen flex justify-center items-start bg-white font-jockey text-[#30475E] px-[100px] py-12 gap-6">

   <!-- SVG avec branches derri√®re et taille r√©duite --> <svg id="lunette" width="800" height="360" viewBox="0 0 1109 235" fill="none" xmlns="http://www.w3.org/2000/svg"> <!-- Branches derri√®re --> <g id="branches"> <path d="M11.1727 117.99C11.1727 117.99 146.638 102.701 161.955 93.9441C177.272 85.1876 192.534 72.094 215.482 67.7295C238.43 63.365 392.479 37.1503 392.479 37.1503C392.479 37.1503 412.133 31.6878 440.544 52.4399C468.954 73.192 531.238 139.84 548.696 137.672C566.182 135.476 574.911 111.457 569.448 100.532C563.986 89.607 457.81 10.6337 439.446 5.47317C413.286 -1.8834 379.358 -1.08735 337.826 5.47317C296.322 12.0337 18.8038 69.5412 18.8038 69.5412C18.8038 69.5412 -17.2379 86.3405 11.1453 118.018L11.1727 117.99Z" fill="white" stroke="#1D1D1B" stroke-width="0.5" stroke-miterlimit="10"/> <g style="mix-blend-mode:multiply"> <path d="M558.551 105.967C558.551 105.967 557.7 122.849 547.626 121.256C533.983 119.115 449.3 28.3935 420.889 32.758C420.889 32.758 444.304 40.1969 471.562 64.7097C489.432 80.7953 566.044 168.607 558.551 105.967Z" fill="#706F6F"/> </g> <path d="M741.23 185.271L989.761 103.525C989.761 103.525 1050.51 88.0706 1059.35 92.49C1068.19 96.9095 1107.96 176.432 1107.96 185.271C1107.96 194.109 1101.32 223.728 1092.51 226.143C1086.11 227.9 1077.88 226.445 1073.73 214.587C1069.86 203.552 1054.95 127.489 1039.5 128.202C1024.05 128.916 900.329 171.985 900.329 171.985C900.329 171.985 863.876 189.663 848.421 202.921C832.967 216.179 760.06 233.857 760.06 233.857C760.06 233.857 733.544 212.858 741.285 185.243L741.23 185.271Z" fill="white" stroke="#1D1D1B" stroke-width="0.5" stroke-miterlimit="10"/> <g style="mix-blend-mode:multiply"> <path d="M759.209 186.506C759.209 186.506 1039.94 89.9097 1055.26 98.6936C1055.26 98.6936 1005.3 105.529 940.625 131.304C875.954 157.08 759.209 191.776 759.209 191.776V186.506Z" fill="#706F6F"/> </g> <g style="mix-blend-mode:multiply"> <path d="M1044.74 126.005C1044.74 126.005 1053.69 126.005 1058.41 135.476C1063.13 144.946 1085.23 203.304 1085.23 203.304C1085.23 203.304 1087.35 216.974 1099.42 195.948C1099.42 195.948 1091 222.19 1084.71 214.586C1078.42 206.982 1057.89 142.311 1057.89 142.311C1057.89 142.311 1050.01 123.809 1044.74 126.005Z" fill="#706F6F"/> </g> </g> <!-- Monture devant --> <g id="monture"> <path d="M774.574 119.218C773.915 109.857 748.304 104.889 739.685 101.65C731.066 98.4108 696.589 107.03 696.589 107.03C663.182 98.4107 546.85 82.2428 480.064 82.2428C413.279 82.2428 390.66 113.481 383.111 112.41C375.562 111.34 335.705 110.269 318.467 107.03C301.228 103.791 304.467 68.2433 210.726 34.3427C117.012 0.442143 23.2707 0.25 23.2707 0.25C-13.3749 13.0416 4.71459 51.0048 4.71459 51.0048L10.3418 68.4355C22.2002 74.0078 18.9611 97.3128 23.2707 131.79C27.5803 166.267 43.7483 210.434 62.0574 237.362C80.3665 264.29 149.321 294.458 183.798 295.528C218.275 296.599 248.442 290.148 271.061 253.503C293.679 216.884 317.396 152.24 317.396 152.24L345.395 156.55C345.395 156.55 353.383 157.401 360.081 165.032C366.778 172.663 372.241 187.074 380.943 212.547C401.695 273.212 449.897 320.288 449.897 320.288C449.897 320.288 465.269 340.683 541.689 355.04C605.043 366.953 658.9 348.287 658.9 348.287C707.541 328.605 718.274 224.872 718.274 224.872C718.274 224.872 723.297 188.364 739.712 179.168C759.943 167.804 762.414 166.981 774.601 164.565C784.511 162.616 775.26 128.523 774.601 119.163L774.574 119.218ZM239.823 257.867C213.965 271.867 151.489 277.247 112.702 247.107C73.9157 216.939 55.6067 164.153 50.2265 101.677C44.8463 39.2014 69.7159 32.4213 69.7159 32.4213C69.7159 32.4213 110.561 30.5821 163.347 43.4836C216.134 56.4124 274.3 93.0306 275.398 116.747C276.468 140.437 265.708 243.868 239.85 257.867H239.823ZM663.182 324.653C638.395 336.511 604.247 337.582 575.535 335.413C546.822 333.272 472.488 331.103 445.56 249.22C445.56 249.22 438.011 210.434 431.56 201.814C425.109 193.195 405.702 162.067 405.702 151.224C405.702 128.633 425.329 115.622 425.329 115.622C425.329 115.622 447.728 101.622 476.798 101.622C505.894 101.622 654.536 109.171 675.013 137.17C695.491 165.169 694.393 197.505 697.632 223.363C700.871 249.22 687.942 312.767 663.155 324.625L663.182 324.653Z" fill="white" stroke="#1D1D1B" stroke-width="0.5" stroke-miterlimit="10"/> </g> </svg>

    <!-- Panneau de personnalisation -->
    <div class="bg-[#F5F5F5] w-full max-w-xl p-6 rounded-xl shadow-md flex flex-col gap-6">
      <h1 class="text-3xl font-jockey text-[#30475E] mb-4">Personnalisation</h1>

      <!-- Couleur branches -->
      <p class="font-livvic text-lg">Couleur des branches</p>
      <div class="flex gap-6">
        {couleur_branches?.length ? (
          couleur_branches.map((c) => {
            const hex = c.hex_couleur || c.couleur_branches;
            return (
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="couleurBranches" value={hex} data-id={c.id} class="hidden peer">
                <span class="w-10 h-10 rounded-full border-2 border-gray-400 peer-checked:border-black" style={`background-color:${hex}`}></span>
              </label>
            );
          })
        ) : (
          <span class="text-sm text-red-500">Aucune couleur branches trouv√©e dans PocketBase.</span>
        )}
      </div>

      <!-- Couleur monture -->
      <p class="font-livvic text-lg mt-4">Couleur de la monture</p>
      <div class="flex gap-6">
        {couleur_monture?.length ? (
          couleur_monture.map((c) => {
            const hex = c.hex_couleur || c.couleur_monture;
            return (
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="couleurMonture" value={hex} data-id={c.id} class="hidden peer">
                <span class="w-10 h-10 rounded-full border-2 border-gray-400 peer-checked:border-black" style={`background-color:${hex}`}></span>
              </label>
            );
          })
        ) : (
          <span class="text-sm text-red-500">Aucune couleur monture trouv√©e dans PocketBase.</span>
        )}
      </div>

      <div class="flex gap-4 mt-6 justify-end">
        <button id="saveBtn" class="bg-[#F05454] text-white px-6 py-2 rounded-full">Enregistrer</button>
      </div>
    </div>
  </div>
</Layout>

<script type="module">
  const svg = document.getElementById("lunette");
  const userData = localStorage.getItem('user');
  const userId = userData ? JSON.parse(userData)?.record?.id : null;
  const urlParams = new URLSearchParams(window.location.search);
  const lunetteId = urlParams.get("id");

  let couleurBranchesHex = ""; // Pour changer la couleur du SVG
  let couleurBranchesId = ""; // Pour enregistrer dans PocketBase
  let couleurMontureHex = "";
  let couleurMontureId = "";

  // üé® Quand on clique sur un radio pour les branches
  document.querySelectorAll('input[name="couleurBranches"]').forEach(radio => {
    radio.addEventListener("change", e => {
      couleurBranchesHex = e.target.value; // Le code hex (ex: #D07841)
      couleurBranchesId = e.target.getAttribute("data-id"); // L'ID du record COULEUR
      svg.querySelectorAll("#branches path").forEach(path => path.setAttribute("fill", couleurBranchesHex));
      console.log('Couleur branches s√©lectionn√©e:', { hex: couleurBranchesHex, id: couleurBranchesId });
    });
  });

  // üé® Quand on clique sur un radio pour la monture
  document.querySelectorAll('input[name="couleurMonture"]').forEach(radio => {
    radio.addEventListener("change", e => {
      couleurMontureHex = e.target.value;
      couleurMontureId = e.target.getAttribute("data-id");
      svg.querySelectorAll("#monture path").forEach(path => path.setAttribute("fill", couleurMontureHex));
      console.log('Couleur monture s√©lectionn√©e:', { hex: couleurMontureHex, id: couleurMontureId });
    });
  });

  function getSVGCode() {
    return svg.outerHTML;
  }

  document.querySelector("#saveBtn").addEventListener("click", async e => {
    e.preventDefault();
    
    if (!lunetteId) {
      alert("Erreur : Aucune lunette √† sauvegarder. Recommencez depuis Personnalisation 1.");
      return;
    }
    
    if (!couleurBranchesId || !couleurMontureId) {
      alert("Veuillez s√©lectionner les couleurs pour les branches et la monture.");
      return;
    }
    
    try {
      console.log('Sauvegarde lunette ID:', lunetteId);
      console.log('IDs couleurs:', { couleurBranchesId, couleurMontureId });
      
      const response = await fetch("/js/saveLunette", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: lunetteId,
          couleur_branches: couleurBranchesId, // Avec 's' pour correspondre √† l'API
          couleur_monture: couleurMontureId,
          image: getSVGCode(),
        }),
      });
      
      const result = await response.json();
      console.log('R√©sultat sauvegarde:', result);
      
      if (result.ok) {
        window.location.href = "/bibliotheque";
      } else {
        console.error('Erreur d√©tails:', result.details);
        alert("Erreur lors de la sauvegarde: " + (result.error || "Inconnue"));
      }
    } catch (err) {
      console.error(err);
      alert("Erreur de connexion: " + err.message);
    }
  });
</script>
